<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>profify edit</title>


  <style>
    /* ê¸°ë³¸ ì„¸íŒ… */
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
    }

    /* íƒ€ì´í‹€ ìŠ¤íƒ€ì¼ */
    h1, h2, h3, h4 {
      color: #fff;
      margin: 0 0 16px 0;
    }

    /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
    .navbar {
      background-color: #1a1a1a;
      padding: 20px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      width: 100%;
      height: 85px;
      z-index: 1000;
      box-sizing: border-box;
    }

    .logo {
      font-size: 25px;
      font-weight: bold;
      color: #1DB954;
    }

    .logo a {
      color: #1DB954;
      text-decoration: none;
    }
    /* ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ */
    .nav-links {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-size: 17px;
      padding: 8px 14px;
      border-radius: 6px;
      transition: background-color 0.3s;
      cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
    }

    .nav-links a:hover {
      background-color: #2c2c2c; /* hover ì‹œ ê°•ì¡° íš¨ê³¼ */
    }


    /* í¼ */
    form#editForm {
      max-width: 400px;
      margin: 140px auto 40px auto; /* ìƒë‹¨ ì—¬ë°± ê³ ë ¤ */
      padding: 30px;
      background-color: #1e1e1e;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #ccc;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border: none;
      border-radius: 6px;
      background-color: #2a2a2a;
      color: #fff;
      font-size: 15px;
    }

    select option {
      background-color: #2a2a2a;
      color: #fff;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background-color: #1db954;
      color: white;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #1ed760;
    }

    /* í”„ë¡œí•„ ì´ë¯¸ì§€ */
    #profileImage {
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    #profileImage:hover {
      transform: scale(1.05);
    }

    #imagePlaceholder {
      color: #888;
      font-size: 14px;
      margin-bottom: 10px;
    }

    #statusMessage {
      color: #ccc;
      font-style: italic;
    }

    /* ì´ë¯¸ì§€ ê´€ë ¨ ë²„íŠ¼ */
    .image-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }
    .image-buttons .primary-btn {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      background-color: #1db954;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 120px;
      max-width: 200px; /* âœ… ì¶”ê°€ */
      width: auto;       /* âœ… ì¶”ê°€ */
    }


    .image-buttons .primary-btn:hover {
      background-color: #1ed760;
    }

    .image-buttons .subtle-btn {
      padding: 6px 12px;
      font-size: 12px;
      color: #aaa;
      background-color: transparent;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
      min-width: 100px;
      max-width: 200px;  /* âœ… ì¶”ê°€ */
      width: auto;       /* âœ… ì¶”ê°€ */
    }

    .image-buttons .subtle-btn:hover {
      background-color: #2a2a2a;
      color: #fff;
    }

    /* ë§í¬ ë²„íŠ¼ */
    .edit-link {
      color: #ffffff;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.2s ease;
      display: inline-block;
      padding: 6px 14px;
      border-radius: 8px;
      background-color: transparent;
      border: 1px solid #444;
      font-size: 14px;
    }

    .edit-link:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: scale(0.95); /* ì‚´ì§ ì¤„ì–´ë“œëŠ” ëŠë‚Œ */
    }

    .edit-link:active {
      transform: scale(0.90); /* í´ë¦­ ì‹œ ë” ëˆŒë¦¼ */
    }


  </style>


</head>
<body>
<div class="navbar">
  <div class="logo">
    <a th:href="@{/home}">FROPIFY</a>
  </div>
  <div class="nav-links">
    <a href="/home">í™ˆ</a>
    <a href="/user/mypage">ë§ˆì´í˜ì´ì§€</a>
    <a href="/user/logout">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>






<!-- ğŸ”µ ì „ì²´ ì •ë³´ ìˆ˜ì • í¼ -->
<form id="editForm" th:action="@{/user/edit/go}" method="post" enctype="multipart/form-data">


  <!-- ğŸ”µ í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¹ì…˜ -->
  <div style="text-align: center; margin-bottom: 30px;">
    <div id="imagePlaceholder">ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <img id="profileImage"
         th:src="${user.image != null and user.image != '' and user.image != 'profile.png' ? user.image : '/icons/profile.png'}"
         alt="profile image"
         style="width: 150px; border-radius: 50%; display: block; margin: 0 auto 10px;"
         onerror="this.src='/icons/profile.png';" />

    <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
    <input type="file" id="imageInput" name="image" accept="image/*" style="display: none;" onchange="uploadImage()" />

    <div class="image-buttons">
      <button type="button" class="primary-btn" onclick="document.getElementById('imageInput').click();">ì´ë¯¸ì§€ ë³€ê²½</button>
      <button type="button" class="subtle-btn" onclick="resetToDefault()">ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ</button>
    </div>
  </div>



  </div>


  <form th:action="@{/user/edit/go}" method="post">
    <!-- ğŸ”µ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • -->
    <div style="max-width: 300px; margin: 0 auto;">

      <label for="name">ë‹‰ë„¤ì„</label>
      <input type="text" id="name" name="name" th:value="${user.nickname}" required style="width: 100%; margin-bottom: 10px;" />

      <label for="email">ì´ë©”ì¼ (ì„ íƒ)</label>
      <input type="email" id="email" name="email"
             th:value="${user.email}" placeholder="ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤"
             style="width: 100%; margin-bottom: 10px;" />

      <!-- ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ìˆ¨ê¹€) -->
      <div th:if="${user.provider != 'KAKAO'}">
        <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="currentPassword" name="currentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
               style="width: 100%; margin-bottom: 10px;" />

        <!-- ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì˜ì—­ -->
        <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="newPassword" name="newPassword" placeholder="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
               style="width: 100%; margin-bottom: 10px;" />
      </div>

      <label for="gender">ì„±ë³„</label>
      <select id="gender" name="gender" style="width: 100%; margin-bottom: 10px;">
        <option th:selected="${user.gender == null}" value="">ì„ íƒ ì•ˆ í•¨</option>
        <option th:selected="${user.gender == 'ë‚¨ì„±'}" value="ë‚¨ì„±">ë‚¨ì„±</option>
        <option th:selected="${user.gender == 'ì—¬ì„±'}" value="ì—¬ì„±">ì—¬ì„±</option>
      </select>

      <div id="statusMessage" style="color: #555; font-size: 14px; margin-bottom: 15px;"></div>
      <button type="submit" style="width: 100%;">ì •ë³´ ìˆ˜ì •</button>
    </div>
  </form>







  <script th:inline="javascript">
  const profileImage = document.getElementById('profileImage');
  const placeholder = document.getElementById('imagePlaceholder');
  const imageInput = document.getElementById('imageInput');
  const deleteForm = document.getElementById('deleteForm');
  const statusMessage = document.getElementById('statusMessage');

  const imageUrl = /*[[${user.image}]]*/ '/icons/profile.png';
  const defaultImage = '/icons/profile.png';

  function showStatus(msg, duration = 2000) {
    if (!statusMessage) return;
    statusMessage.textContent = msg;
    statusMessage.style.display = 'block';
    if (duration > 0) {
      setTimeout(() => statusMessage.style.display = 'none', duration);
    }
  }

  function loadImage(url, loadingMsg = "ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...") {
    if (!profileImage || !placeholder) return;
    placeholder.textContent = loadingMsg;
    placeholder.style.display = 'block';
    profileImage.style.display = 'none';

    profileImage.onload = () => {
      placeholder.style.display = 'none';
      profileImage.style.display = 'block';
    };
    profileImage.onerror = () => {
      profileImage.src = defaultImage;
    };
    profileImage.src = url + '?t=' + Date.now(); // ìºì‹œ ë°©ì§€
  }

  // ğŸ”¥ ì´ í•¨ìˆ˜ëŠ” DOMContentLoaded ë°”ê¹¥ì— ìˆì–´ì•¼ í•¨
  function resetToDefault() {
    showStatus("ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½ ì¤‘...");

    fetch('/user/mypage/delete-image', {
      method: 'POST'
    })
            .then(response => {
              if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
              return response.json();
            })
            .then(data => {
              if (!data.imageUrl) throw new Error("imageUrl ëˆ„ë½");
              loadImage(data.imageUrl, "ê¸°ë³¸ ì´ë¯¸ì§€ ì ìš© ì¤‘...");
              showStatus("âœ… ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            })
            .catch(err => {
              console.error("ê¸°ë³¸ ì´ë¯¸ì§€ ë³µì› ì‹¤íŒ¨:", err);
              showStatus("âŒ ê¸°ë³¸ ì´ë¯¸ì§€ ë³µì› ì‹¤íŒ¨", 3000);
            });
  }

  window.addEventListener('DOMContentLoaded', () => {
    if (profileImage) loadImage(imageUrl);

    if (imageInput) {
      imageInput.addEventListener('change', () => {
        const file = imageInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        showStatus("ì´ë¯¸ì§€ ë³€ê²½ ì¤‘...");
        loadImage(defaultImage, "ë³€ê²½ëœ ì´ë¯¸ì§€ ì ìš© ì¤‘...");

        fetch('/user/mypage/upload-image', {
          method: 'POST',
          body: formData
        })
                .then(response => {
                  if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
                  return response.json();
                })
                .then(data => {
                  if (!data.imageUrl) throw new Error("imageUrl ëˆ„ë½");
                  loadImage(data.imageUrl, "ë³€ê²½ëœ ì´ë¯¸ì§€ ì ìš© ì¤‘...");
                  showStatus("âœ… ì´ë¯¸ì§€ ë³€ê²½ ì™„ë£Œ!");
                })
                .catch(err => {
                  console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", err);
                  showStatus("âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨", 3000);
                });
      });
    }

    // hidden input ë™ì  ì¶”ê°€
    if (!document.getElementById('resetImage')) {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'resetImage';
      hiddenInput.id = 'resetImage';
      hiddenInput.value = 'true';
      const editForm = document.getElementById('editForm');
      if (editForm) editForm.appendChild(hiddenInput);
    }

    // ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë¦¬ì…‹ (submit ë°©ì‹)
    if (deleteForm) {
      deleteForm.addEventListener('submit', (e) => {
        e.preventDefault();
        showStatus("ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½ ì¤‘...");
        loadImage(defaultImage);

        fetch('/user/mypage/delete-image', { method: 'POST' })
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                  if (!data.imageUrl) throw new Error("ë¦¬ì…‹ ê²°ê³¼ ì—†ìŒ");
                  loadImage(data.imageUrl);
                  showStatus("âœ… ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½ ì™„ë£Œ!");
                })
                .catch(err => {
                  console.error("ë¦¬ì…‹ ì˜¤ë¥˜:", err);
                  alert("ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½ ì‹¤íŒ¨");
                });
      });
    }
  });



  // ğŸ” í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  function verifyPassword() {
    const currentPwInput = document.getElementById("currentPassword");
    const statusMsg = document.getElementById("statusMessage");
    const newPwSection = document.getElementById("newPasswordSection");

    const currentPw = currentPwInput.value.trim();

    if (!currentPw) {
      statusMsg.innerText = "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      newPwSection.style.display = "none";
      return;
    }

    fetch("/user/check-password", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ password: currentPw })
    })
            .then(res => {
              if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");
              return res.json();
            })
            .then(data => {
              if (data.match === true) {
                statusMsg.innerText = "âœ… ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ!";
                newPwSection.style.display = "block";
              } else {
                statusMsg.innerText = "âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                newPwSection.style.display = "none";
              }
            })
            .catch(() => {
              statusMsg.innerText = "âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
              newPwSection.style.display = "none";
            });
  }
  </script>
 </body>
</html>